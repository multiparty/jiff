<!-- Basic UI for running the demo in the browser -->

<html>
  <head>
    <title>Vote under MPC</title>
    <style>
      .error {
        color: #FF0000;
      }
    </style>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/lib/sodium.js"></script>
    <script src="/lib/jiff-client.js"></script>
    
    <script type="text/javascript">
      function error(err) {
        alert('Your browser is not supported!');
        console.log(err);
      }
      
      function hostname() {
        var hostname = window.location.hostname.trim();
        var port = window.location.port;
        if (port == null || port === '') {
          port = '80';
        }
        if (!(hostname.startsWith('http://') || hostname.startsWith('https://'))) {
          hostname = 'http://' + hostname;
        }
        if (hostname.endsWith('/')) {
          hostname = hostname.substring(0, hostname.length-1);
        }
        if (hostname.indexOf(':') > -1 && hostname.lastIndexOf(':') > hostname.indexOf(':')) {
          hostname = hostname.substring(0, hostname.lastIndexOf(':'));
        }
        return hostname + ':' + port;
      }
    
      function main() {       
        // rerad input
        var input = [0, 0];
        if (document.getElementById('radioVote1').checked) {
          input[0] = 1;
        } else if (document.getElementById('radioVote2').checked) {
          input[1] = 1;
        } else {
          alert('Please select an option');
          return;
        }
        console.log(input);

        // connect JIFF
        var _hostname = hostname();
        var jiff_instance = jiff.make_jiff(_hostname, 'secdev');
        jiff_instance.wait_for([1, 's1'], function () {
          try {
            compute(jiff_instance, input);
          } catch (err) {
            error(err);
          }
        });
      }

      // Create Jiff instance and share input
      function compute(jiff_instance, input) {
        var senders = [];
        for (var i = 2; i <= jiff_instance.party_count; i++) {
          senders.push(i);
        }

        var _ = jiff_instance.share(input[0], 2, [1,'s1'], senders);
        _ = jiff_instance.share(input[1], 2, [1,'s1'], senders);

        // disconnect after share is complete
        setTimeout(function () {
          try {
           jiff_instance.disconnect(true);
            document.getElementById('output').innerHTML = 'You have successfully submitted your answer!';
          } catch (err) {
            error(err);
          }
        }, 1000);
      }
      
      function submit() {
        try {
          var obj = Object.assign({}, {t: 'test'}); // test browser support for Object.assign
          document.getElementById('button').setAttribute('disabled', 'disabled'); // disable submission forever
          document.getElementById('output').innerHTML = 'Working...';

          main();
        } catch (err) {
          error(err);
        }
      }
    </script>
  </head>
  <body>
    <h1>Vote demo under MPC - Secdev 2019</h1>
    <h1>Was the MPC primer useful?</h1>
    <label><input type="radio" name="vote" id="radioVote1" value="0" selected="selected"/>Yes</label> <br>
    <label><input type="radio" name="vote" id="radioVote2" value="1"/>No</label> <br>
    <br>
    <button onclick="submit();" id="button">Vote</button><br/>
    <div id="output"></div>
  </body>
</html>
